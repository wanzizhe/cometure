import React, { PropTypes, Component } from 'react';
import { extend, defaults, hexToRgbas, serialize, deserialize, getRandomData } from '../../../components/utils';
import { SideComponent } from '../util-component';
import pois from '../../mock/poi.json';
import districts from '../../mock/districts.json';
import villagesNames from '../../mock/villagesNames.json';
import { PieChart } from '../../../components/';
import { Pie } from '../../../components/';
import cloneDeep from 'lodash/cloneDeep';
import iconStyles from '@iconfont';

import showStyles from '../style.scss';
import styles from './style.scss';
import { getDate } from '../../../components/date-picker1/datetime';
import { Option } from 'rc-select';

function getRandomArrayArr(arr, n) {
    let result = [];
    let count = arr.length;
    for (let i = 0; i < n; i++) {
        let index = ~~(Math.random() * count) + i;
        result[i] = arr[index];
        arr[index] = arr[i];
        count--;
    }

    return result;
}

function rd(n, m) {
    let count = m - n + 1;  
    return Math.floor(Math.random() * count + n);
}

function getSum(arr) {
    let sum = 0;
    for(let i = 0; i < arr.length; i++){
        sum += arr[i].value;
    }
    return sum;
}

export default class Demo extends React.Component {

    render() {

        let opt = this.props || {};
        const fontRatio = opt.fontRatio;

        let ages = ['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60-69', '70-79', '80-89', '90-99', '100以上'];
        let data = [];
        let dataB = [];
        for(let i = 0; i < 11; i++) {
            let value = rd(100, 20000);
            if(i === 10) {
                value = rd(1, 100);
            }
            data.push({
                value,
                name: ages[i]
            });            
            dataB.push({
                value,
                name: ages[i]
            });
        }
        let genderData = ['30%', '70%'];
        let genderDataB = ['60.5%', '39.5%'];
        let lengendColor = '#A5B3EA';
        
        let names = getRandomArrayArr(pois, 10);
        let dataC = [];
        let dataD = [];
        let dataE = [];
        let dataF = [];
        let districtNames = getRandomArrayArr(districts, 10);
        let villages = getRandomArrayArr(villagesNames, 10);

        for(let i = 0; i < 10; i++) {
            dataC.push({
                value: rd(100, 20000),
                name: names[i]
            });
            dataD.push({
                value: rd(100, 20000),
                name: names[i]
            });
            dataE.push({
                value: rd(100, 20000),
                name: names[i]
            });
            dataF.push({
                value: rd(100, 20000),
                name: villages[i],
                prefixName: districtNames[i]
            });
        }
        
        dataC.push({
            value: rd(1, 100),
            name: '其它'
        });
        dataD.push({
            value: rd(1, 100),
            name: '其它'
        });
        dataE.push({
            value: rd(1, 100),
            name: '其它'
        });

        let optionsB = {
            title: {
                text: '中关村街道居住用户性别、年龄分布2',
                subtext: '年龄分布 (%)'
            },
            legend: {
                formatter: function(item) {
                    let text = [
                        '{a|' + item + '}'
                    ].join('');
                    return text;
                },
                textStyle: {
                    rich: {
                        a: {
                            width: 40 * fontRatio,
                            fontSize: 12 * fontRatio,
                            color: lengendColor
                        }
                    }
                },
                data: ages.map(item => {
                    return {
                        name: item,
                        icon: 'rect'
                    }       
                })
            },
            tooltip: {
                formatter: '{b}<br/> {c} ({d}%)'
            },
            series: [{
                radius: ['30%', '60%'],
                center: ['50%', 120 * fontRatio],
                label: {
                    position: 'outside',
                    color: lengendColor
                },
                data: dataB,
            }],
            ratio: {
                show: true,
                data: genderDataB
            },
            orderBy: 'DESC'
        };
        
        let optionsEditB = defaults( {
            showCheckbox: true 
            , onCheckboxCallback: ( params ) => {
                let _options = {};
                let _child = null;
                if ( params.data.checked ) {
                    _options = cloneDeep(optionsB);
                    _child = genderDataB;
                }
                opt.ee && opt.ee.trigger( 'pieChart-options-change', [ { data: serialize(_options) } ] );
            }
        }
        , optionsB );

        let optionsD = {
            title: {
                text: '中关村街道便民设施POI数量',
                subtext: getSum(dataD)
            },
            legend: {
                formatter: function(item) {
                    let text = [
                        '{a|' + item + '}'
                    ].join('');
                    return text;
                },
                textStyle: {
                    rich: {
                        a: {
                            width: 110 * fontRatio,
                            fontSize: 12 * fontRatio,
                            color: lengendColor
                        }
                    }
                }
            },
            tooltip: {
                formatter: '{b}: {c}'
            },
            series: [{
                radius: ['25%', '50%'],
                center: ['50%', 120 * fontRatio],
                label: {
                    position: 'outside',
                    formatter: function(item) {
                        return item.value
                    }
                },
                data: dataD
            }],
            height: 360 * fontRatio,
            orderBy: 'DESC',
            classNames: {
                container: styles['pie-chart-container-d'],
                header: styles['header'],
                title: styles['pie-header-title']
            }
        };
        
        let optionsEditD = defaults( {
            showCheckbox: true 
            , onCheckboxCallback: ( params ) => {
                let _options = {};
                if ( params.data.checked ) {
                    _options = cloneDeep(optionsD);
                }
                opt.ee && opt.ee.trigger( 'pieChart-options-change', [ { data: serialize(_options) } ] );
            }
        }
        , optionsD );
        
        let optionsD1 = {
            title: {
                text: '中关村街道便民设施POI数量',
                subtext: getSum(dataD)
            },
            legend: {
                orient: 'vertical',
                width: '100%',
                formatter: function(item) {
                    let text = [
                        '{a|' + item + '}'
                    ].join('');
                    return text;
                },
                textStyle: {
                    rich: {
                        a: {
                            width: 110 * fontRatio,
                            fontSize: 12 * fontRatio,
                            color: lengendColor
                        }
                    }
                }
            },
            tooltip: {
                formatter: '{b}: {c}'
            },
            series: [{
                radius: ['25%', '50%'],
                center: ['50%', 120 * fontRatio],
                label: {
                    position: 'outside',
                    formatter: function(item) {
                        return item.value
                    }
                },
                data: dataD.slice(0, 6)
            }],
            height: 360 * fontRatio,
            orderBy: 'DESC',
            classNames: {
                container: styles['pie-chart-container-d'],
                header: styles['header'],
                title: styles['pie-header-title']
            }
        };
        
        let optionsEditD1 = defaults( {
            showCheckbox: true 
            , onCheckboxCallback: ( params ) => {
                let _options = {};
                if ( params.data.checked ) {
                    _options = cloneDeep(optionsD);
                }
                opt.ee && opt.ee.trigger( 'pieChart-options-change', [ { data: serialize(_options) } ] );
            }
        }
        , optionsD1 );

        let optionsF = {
            ref: {
                dataF
            },
            title: {
                text: '中关村街道外来工作居住地分布',
                subtext: dataF[0].name
            },
            legend: {
                dataF,
                formatter: function(item) {
                    const replace = 'dataF';
                    let prefixName = '';
                    for(let i = 0; i < dataF.length; i++) {
                        if(dataF[i].name === item) {
                            prefixName = dataF[i].prefixName.substr(0, dataF[i].prefixName.length - 1);
                            break;
                        }
                    }
                    let text = [
                        '{a|' + prefixName + '}',
                        ' ',
                        '{b|' + item + '}'
                    ].join('');

                    return text;
                },
                textStyle: {
                    rich: {
                        a: {
                            width: 28 * fontRatio,
                            fontSize: 10 * fontRatio,
                            color: '#9f9fa0'
                        },
                        b: {
                            width: 74 * fontRatio,
                            fontSize: 10 * fontRatio,
                            color: '#585757'
                        }
                    }
                }
            },
            tooltip: {
                formatter: '{b}<br/>{c}'
            },
            series: [{
                radius: ['30%', '55%'],
                center: ['50%', 120 * fontRatio],
                label: {
                    position: 'outside',
                    formatter:'{d}%'
                },
                data: dataF
            }],
            orderBy: 'DESC'
        };
        
        
        let optionsEditF = defaults( {
            showCheckbox: true 
            , onCheckboxCallback: ( params ) => {
                let _options = {};
                if ( params.data.checked ) {
                    _options = cloneDeep(optionsF);
                }
                opt.ee && opt.ee.trigger( 'pieChart-options-change', [ { data: _options, ref: {dataF} } ] );
            }
        }
        , optionsF );

        let dataG = [{
            value: 24,
            name: '平原五区'
        }, {
            value: 10,
            name: '生态涵养三区'
        }, {
            value: 30,
            name: '城六区'
        }];

        let optionsG = {
            unit: '(%)',
            title: {
                text: '三类区常住外来人口占比'
            },
            legend: {
                show: false
            },
            tooltip: {
                formatter: '{b}: {c}'
            },
            series: [{
                radius: [0, '70%'],
                center: ['50%', '50%'],
                label: {
                    color: '#fff',
                    fontSize: 12 * fontRatio,
                    position: 'inner',
                    formatter: (item) => {
                        return item.value + '\n' + item.name;
                    }
                },
                data: dataG
            }],
            height: 280 * fontRatio,
            orderBy: 'DESC',
            opacity: [0.5, 1]
        };


        let optionsEditG = defaults( {
            showCheckbox: true 
            , onCheckboxCallback: ( params ) => {
                let _options = {};
                if ( params.data.checked ) {
                    _options = cloneDeep(optionsG);
                }
                opt.ee && opt.ee.trigger( 'pieChart-options-change', [ { data: serialize(_options) } ] );
            }
        }
        , optionsG );
        
        let dataH = [{
            value: 13815793,
            name: '北京',
        }, {
            value: 656975,
            name: '河北',
        }, {
            value: 242632,
            name: '河南',
        }, {
            value: 210665,
            name: '山西',
        }, {
            value: 159750,
            name: '山东',
        }, {
            value: 124619,
            name: '辽宁',
        }, {
            value: 113097,
            name: '黑龙',
        }, {
            value: 80378,
            name: '四川',
        }, {
            value: 69080,
            name: '江苏',
        }, {
            value: 67500,
            name: '天津',
        }, {
            value: 63636,
            name: '内蒙古',
        }, {
            value: 62406,
            name: '安徽',
        }, {
            value: 60312,
            name: '陕西',
        }, {
            value: 59929,
            name: '吉林',
        }, {
            value: 58071,
            name: '湖北',
        }, {
            value: 57793,
            name: '广东',
        }, {
            value: 50903,
            name: '上海',
        }, {
            value: 45900,
            name: '浙江',
        }, {
            value: 45021,
            name: '甘肃',
        }, {
            value: 33299,
            name: '湖南',
        }, {
            value: 30006,
            name: '江西',
        }, {
            value: 27531,
            name: '重庆',
        }, {
            value: 24972,
            name: '福建',
        }, {
            value: 19449,
            name: '云南',
        }, {
            value: 16625,
            name: '贵州',
        }, {
            value: 13342,
            name: '广西',
        }, {
            value: 12068,
            name: '新疆',
        }, {
            value: 6756,
            name: '宁夏',
        }, {
            value: 5309,
            name: '海南',
        }, {
            value: 3337,
            name: '青海',
        }, {
            value: 1767,
            name: '西藏',
        }];
        
        const dataHTotal = dataH.reduce( (temp, v) => temp + v.value, 0);
        const top10SeriesData = [];
        top10SeriesData.push(...(dataH.filter(v => v && v.name && v.name != '未知' && v.name != '北京').sort((a, b) => b.value - a.value)).slice(0, 10));
        if (dataH.length > 10) {
            top10SeriesData.push(dataH.slice(10).reduce((temp, v) => {
                temp.value += v.value;
                return temp;
            }, {name: '其他', value: 0}));
        }
        const beijingPercent = (dataH.find(v => v.name == '北京').value / dataHTotal * 100).toFixed(2) + '%';
        const otherPercent = (dataH.reduce((temp, v) => {
            if (v.name && v.name != '未知' && v.name != '北京') {
                return temp + v.value;
            } else {
                return temp;
            }
        }, 0) / dataHTotal * 100).toFixed(2) + '%';
        const unknownPercent = (dataH.reduce((temp, v) => {
            if (!v.name || v.name == '未知') {
                return temp + v.value;
            } else {
                return temp;
            }
        }, 0) / dataHTotal * 100).toFixed(2) + '%';
        let optionsH = {
            title: {
                text: '全市居住用户归属地分布',
            },
            unit: '(%)',
            legend: {
                show: false
            },
            tooltip: {
                formatter: (item) => {
                    return (item.value * 100 / dataHTotal).toFixed(2) + '%';
                }
            },
            series: [{
                radius: [0, '70%'],
                center: ['50%', '50%'],
                label: {
                    fontSize: 12 * fontRatio,
                    position: 'outside',
                    formatter: (item) => {
                        return item.name;
                    }
                },
                data: top10SeriesData
            }],
            height: 280 * fontRatio,
            orderBy: 'custom-order',
            opacity: [0.5, 1],
            ratio: {
                show: true,
                type: 'location',
                label: {
                    primary: '北京',
                    secondary: '其他',
                    unknown: '未知',
                },
                data: [beijingPercent, otherPercent, unknownPercent]
            },
            specialColor: [{name: '未知', opacity: 0.1}]
        };
        
        let optionsEditH = defaults( {
            showCheckbox: true 
            , onCheckboxCallback: ( params ) => {
                let _options = {};
                if ( params.data.checked ) {
                    _options = cloneDeep(optionsH);
                }
                opt.ee && opt.ee.trigger( 'pieChart-options-change', [ { data: serialize(_options) } ] );
            }
        }
        , optionsH );
        
        let optionsI = {
            title: {
                text: '全市居住用户归属地分布',
                subtext: '外省分布'
            },
            unit: '(%)',
            legend: {
                show: false
            },
            tooltip: {
                formatter: (item) => {
                    return (item.value * 100 / dataHTotal).toFixed(2) + '%';
                }
            },
            series: [{
                radius: ['30%', '70%'],
                center: ['50%', 120 * fontRatio],
                label: {
                    fontSize: 12 * fontRatio,
                    position: 'outside',
                    formatter: (item) => {
                        return item.name;
                    }
                },
                data: top10SeriesData
            }],
            height: 280 * fontRatio,
            orderBy: 'custom-order',
            opacity: [0.2, 1],
            ratio: {
                show: true,
                type: 'location',
                label: {
                    primary: '北京',
                    secondary: '外省',
                    unknown: '未知',
                },
                data: [beijingPercent, otherPercent, unknownPercent]
            },
            specialColor: [{name: '未知', opacity: 0.1}]
        };
        
        let optionsEditI = defaults( {
            showCheckbox: true 
            , onCheckboxCallback: ( params ) => {
                let _options = {};
                if ( params.data.checked ) {
                    _options = cloneDeep(optionsI);
                }
                opt.ee && opt.ee.trigger( 'pieChart-options-change', [ { data: serialize(_options) } ] );
            }
        }
        , optionsI );

        
        //南京智控平台大屏饼状图
        let data1 = [{
            value: 600,
            name: '人像卡口',
        }, {
            value: 500,
            name: '车辆卡口',
        }, {
            value: 400,
            name: '全息布控',
        }];
        var colorList = [
            '#0DB2F8', '#2809EA', '#8120D7'
        ];
       data1 = data1.map((item, index) => {
            item.itemStyle = {
                color: colorList[index]
            };
            item.labelLine = {
                show:true,length: 30,lineStyle:{color:colorList[index]}
            };
            item.label = {
                color: colorList[index]
            };
            return item;
        });
        let optionsN = {
            classNames: {
                'content': styles['pie-content']
            },
            // 组件离容器的距离
            grid: { 
                right: 50,
                left: 50,
                bottom: 50,
                top: 0
            },
            title: {
                text: '告警信息来源占比',
                // subtext: 1111,
                subicon: 'warning'
            },
            legend: {
                type: 'scroll',
                orient: 'vertical',
                bottom: 10,
                left: 240,
                formatter: function(item) {//用来格式化图例文本，支持字符串模板和回调函数两种形式
                    let text = [
                        '{a|' + item + '}'
                    ].join('');
                    return text;
                },
                textStyle: {
                    rich: {
                        //注释文本样式
                        a: {
                            fontSize: 10,
                            color: lengendColor,
                        },
                    }
                }
            },
            series: [{
                roseType : 'radius',//是否展示成南丁格尔图,'radius' 扇区圆心角展现数据的百分比，半径展现数据的大小。'area' 所有扇区圆心角相同，仅通过半径展现数据大小。
                radius: ['25%', '65%'],//饼图的半径,第一个是内半径，第二个是外半径
                center: ['50%', '50%'],//饼图的中心（圆心）坐标，数组的第一项是横坐标，第二项是纵坐标。
                label: {
                    formatter: '{d}%'//饼图扇区外侧指示字体展示格式
                },
                data: data1,
            }],
            animationType: 'scale',
            forbiddenItemColor: true,
            height: '100%'
        };


        return (
            <div>
                <h2 className={showStyles.title}>PieChart</h2>
                <hr />
                <div className={showStyles.container}>
                    <div key="10" className={styles.myContainer}>
                        <Pie options={optionsN}/>
                    </div>
                    <SideComponent key="2">
                        <PieChart options={optionsB}/>
                    </SideComponent>
                    <SideComponent key="4">
                        <PieChart options={optionsEditD}/>
                    </SideComponent>
                    <SideComponent key="5">
                        <PieChart options={optionsEditD1}/>
                    </SideComponent>
                    <SideComponent key="6">
                        <PieChart options={optionsF}/>
                    </SideComponent>
                    <SideComponent key="7">
                        <PieChart options={optionsEditG}/>
                    </SideComponent>
                    <SideComponent key="8">
                        <PieChart options={optionsEditH}/>
                    </SideComponent>
                    <SideComponent key="9">
                        <PieChart options={optionsEditI}/>
                    </SideComponent>
                    <PieChartFactory ee={ opt.ee } options={ { title: { text: '请点击前方饼状图复选框' } } }/>
                    
                </div>
            </div>
        );
    
    }
}


class PieChartFactory extends Component {

    /**
     * Constructing
     */
    constructor( props ) {
        super( props );
        this.options = props.options || {};
        this.ee = props.ee;
    }

    componentDidMount() {
        this.registerEvents();
    }

    componentWillReceiveProps( nextProps ) {
        this.options = nextProps.options;
    }

    render() {
        return (
            <SideComponent key="100">
                <PieChart options={this.options} />
            </SideComponent>
        );
    }

    componentWillUnmount() {
        this.unregisterEvents();
    }

    registerEvents() {
        this.ee && this.ee.on( 'pieChart-options-change', this.onOptionsChange );
    }

    unregisterEvents() {
        this.ee && this.ee.off( 'pieChart-options-change', this.onOptionsChange );
    }
    
    onOptionsChange = ( e ) => {
        const data = deserialize(e.data);
        
        this.options = defaults( 
            { showCheckbox: false, onCheckboxCallback: null, ee: null }
            , data
        );
        
        this.setState( {} );
    }
}


